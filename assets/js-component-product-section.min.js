(()=>{"use strict";const t="product-section",e={json:`data-${t}-json`,area:`data-${t}-area`,doesNotExistText:`data-${t}-doesnotexist`,loadingClass:`data-${t}-loading-class`,errorMessage:`data-${t}-error`},i="statechange";class s extends HTMLElement{_variantId;_data;_optionsValues=[];_optionsHierarchy=[];_optionsAvailability={};_$variantInputs;_$addToCartButtons;_isHydration=!1;_abortController;_latestHTML;constructor(){super()}connectedCallback(){this.addEventListener(i,this._render.bind(this)),this._latestHTML=`<div>${this.outerHTML}</div>`,this._hydrate(),this._adjustRequestURL()}_adjustRequestURL(){"/products_preview"===this._data.section.requestURL&&(this.previewKey=new URLSearchParams(window.location.search).get("preview_key"))}_getURL(t=!1){const e=this._data.section.requestURL.split("?"),i=new URLSearchParams(e[1]);return this._variantId>0&&i.set("variant",this._variantId),t||i.set("section_id",this._data.section.sectionId),this.previewKey&&i.set("preview_key",this.previewKey),`${e[0]}?${i.toString()}`}_hydrate(){this._isHydration=!0;try{const i=this.querySelector(`[${e.json}]`);if(!i)throw new Error(`[${t}] [The mandatory ${e.json} element is not found]`);if(this._data=JSON.parse(i.innerHTML),this._optionsHierarchy=this._data.product.options.map(((t,e)=>e)),!("requestURL"in this._data.section)||!("sectionId"in this._data.section))throw new Error(`[${t}] [Wrong ${e.json} data structure]`);this._$variantInputs=this.querySelectorAll("input[name='id']"),this._$addToCartButtons=this.querySelectorAll("[name='add']"),this.setVariantId(this._data.section.variantId||0)}catch(t){throw this._isHydration=!1,t}this._isHydration=!1}setVariantId(e){let i;if(e>0){const s=this._data.product.variants.find((t=>t.id===e));if(!s)throw new Error(`[${t}] [The variant "${e}" is not found in the product data object]`);return i=this._data.product.options.map(((t,e)=>({name:t,value:s.options[e]}))),this._changeState({variantId:e,optionsValues:i})}return this._changeState({variantId:0,optionsValues:this._data.product.options.map((t=>({name:t,value:null})))})}setOptions(t){let e=!0;const i=this._optionsValues.map((({name:i,value:s})=>{let a=i in t?t[i]:s;return null!=a&&""!==a||(a=null,e=!1),{name:i,value:a}}));if(!e)return this._changeState({variantId:0,optionsValues:i});const s=this._data.product.variants.find((t=>{for(let e=0;e<i.length;e++)if(i[e].value!==t.options[e])return!1;return!0})),a=s?s.id:null;return this._changeState({variantId:a,optionsValues:i})}_changeState({variantId:t,optionsValues:e}){const s=t!==this._variantId,a=e.reduce(((t,e,i)=>t||e.name!==this._optionsValues[i]?.name||e.value!==this._optionsValues[i]?.value),!1);this._variantId=t,this._optionsValues=e;const r=!(!a&&!this._isHydration)&&this._updateAvailability();(s||a||r)&&this.dispatchEvent(new CustomEvent(i,{detail:{isVariantChanged:s}}))}async _render(i){if(this._abortController&&(this._abortController.abort(),this._abortController=void 0),this._$variantInputs.forEach((t=>{t.value=this._variantId||"",t.setAttribute("value",this._variantId||"")})),this._toggleLoadingClasses(!1),this._showErrorMessages(!1),i.detail.isVariantChanged&&!this._isHydration){if(null===this._variantId)return this._$addToCartButtons.forEach((t=>{t.disabled=!0})),void this.querySelectorAll(`[${e.doesNotExistText}]`).forEach((t=>{const i=t.getAttribute(e.doesNotExistText);i&&(t.textContent=i)}));this._data.section.updateURL&&window.history.replaceState({},"",this._getURL(!0)),this._abortController=new AbortController,this._$addToCartButtons.forEach((t=>{t.disabled=!0})),this._toggleLoadingClasses(!0);try{const e=await fetch(this._getURL(),{signal:this._abortController.signal});if(!e.ok)throw new Error(`[${t}] [Response error from the "${e.url}" URL]`);const i=await e.text();this._changeHTML(i),this._toggleLoadingClasses(!1)}catch(t){if("AbortError"!==t.name)throw this._changeHTML(this._latestHTML),this._toggleLoadingClasses(!1),this._showErrorMessages(!0),t}}}_toggleLoadingClasses(t){((t,e,i)=>{t.querySelectorAll(`[${e}]`).forEach((t=>{const s=t.getAttribute(e);s&&(i?t.classList.add(s):t.classList.remove(s))}))})(this,e.loadingClass,t)}_showErrorMessages(t){this.querySelectorAll(`[${e.errorMessage}]`).forEach((e=>{e.hidden=!t}))}_changeHTML(i){const s=(new DOMParser).parseFromString(i,"text/html").querySelector(`${t}${this.id?"#"+this.id:""}`);if(!s)throw new Error(`[${t}] [The "${t}" element is not found]`);this._latestHTML=i,this.querySelector(`[${e.json}]`).innerHTML=s.querySelector(`[${e.json}]`).innerHTML;const a=Array.from(this.querySelectorAll(`[${e.area}]`)),r=Array.from(s.querySelectorAll(`[${e.area}]`));let n=!1;a.length!==r.length?(console.warn(`[${t}] [Previous "${e.area}" elements don't match the new received ones. The HTML of the component will be replaced completely.]`),this.innerHTML=s.innerHTML,s.querySelector("[data-shopify='payment-button']")&&(n=!0)):a.forEach(((t,i)=>{const s=r[i];let a="innerHTML";s.getAttribute(e.area)&&(a=s.getAttribute(e.area)),a.split(",").forEach((e=>{if("innerHTML"===(e=e.trim()))return t.innerHTML=s.innerHTML,void(s.querySelector("[data-shopify='payment-button']")&&(n=!0));s.hasAttribute(e)?t.setAttribute(e,s.getAttribute(e)):t.removeAttribute(e)}))})),n&&window.Shopify?.PaymentButton?.init(),this._hydrate()}_updateAvailability(){const t={};this._data.product.variants.forEach((e=>{for(let i=0;i<this._optionsHierarchy.length;i++){const s=this._optionsHierarchy[i],a=this._data.product.options[s],r=e.options[s];a in t||(t[a]={});const n=t[a];if(n[r]||(n[r]=e.available),e.options[s]!==this._optionsValues[s].value)break}}));const e=this._optionsAvailability;this._optionsAvailability=t;const i=Object.keys(t);if(i.length!==Object.keys(e).length)return!0;for(let s=0;s<i.length;s++){const a=i[s];if(!(a in e))return!0;const r=Object.keys(t[a]);if(r.length!==Object.keys(e[a]).length)return!0;for(let i=0;i<r.length;i++){const s=r[i];if(t[a][s]!==e[a][s])return!0}}return!1}get state(){return{variantId:this._variantId,optionsValues:this._optionsValues,optionsAvailability:this._optionsAvailability}}}customElements.define(t,s)})();