(()=>{"use strict";const t="product-section",e={json:`data-${t}-json`,area:`data-${t}-area`,doesNotExistText:`data-${t}-doesnotexist`,loadingClass:`data-${t}-loading-class`,errorMessage:`data-${t}-error`},i="statechange";class a extends HTMLElement{#t;#e;#i=[];#a=[];#s={};#r;#n;#o=!1;#h;#l;constructor(){super()}connectedCallback(){this.addEventListener(i,this.#d.bind(this)),this.#l=`<div>${this.outerHTML}</div>`,this.#c()}#c(){this.#o=!0;try{const i=this.querySelector(`[${e.json}]`);if(!i)throw new Error(`[${t}] [The mandatory ${e.json} element is not found]`);if(this.#e=JSON.parse(i.innerHTML),this.#a=this.#e.product.options.map(((t,e)=>e)),!("requestURL"in this.#e.section)||!("sectionId"in this.#e.section))throw new Error(`[${t}] [Wrong ${e.json} data structure]`);this.#r=this.querySelectorAll("input[name='id']"),this.#n=this.querySelectorAll("[name='add']"),this.setVariantId(this.#e.section.variantId||0)}catch(t){throw this.#o=!1,t}this.#o=!1}setVariantId(e){let i;if(e>0){const a=this.#e.product.variants.find((t=>t.id===e));if(!a)throw new Error(`[${t}] [The variant "${e}" is not found in the product data object]`);return i=this.#e.product.options.map(((t,e)=>({name:t,value:a.options[e]}))),this.#u({variantId:e,optionsValues:i})}return this.#u({variantId:0,optionsValues:this.#e.product.options.map((t=>({name:t,value:null})))})}setOptions(t){let e=!0;const i=this.#i.map((({name:i,value:a})=>{let s=i in t?t[i]:a;return null!=s&&""!==s||(s=null,e=!1),{name:i,value:s}}));if(!e)return this.#u({variantId:0,optionsValues:i});const a=this.#e.product.variants.find((t=>{for(let e=0;e<i.length;e++)if(i[e].value!==t.options[e])return!1;return!0})),s=a?a.id:null;return this.#u({variantId:s,optionsValues:i})}#u({variantId:t,optionsValues:e}){const a=t!==this.#t,s=e.reduce(((t,e,i)=>t||e.name!==this.#i[i]?.name||e.value!==this.#i[i]?.value),!1);this.#t=t,this.#i=e;const r=!(!s&&!this.#o)&&this.#p();(a||s||r)&&this.dispatchEvent(new CustomEvent(i,{detail:{isVariantChanged:a}}))}async#d(i){if(this.#h&&(this.#h.abort(),this.#h=void 0),this.#r.forEach((t=>{t.value=this.#t||"",t.setAttribute("value",this.#t||"")})),this.#v(!1),this.#g(!1),!i.detail.isVariantChanged||this.#o)return;if(null===this.#t)return this.#n.forEach((t=>{t.disabled=!0})),void this.querySelectorAll(`[${e.doesNotExistText}]`).forEach((t=>{const i=t.getAttribute(e.doesNotExistText);i&&(t.textContent=i)}));this.#e.section.updateURL&&window.history.replaceState({},"",`${this.#e.section.requestURL}${this.#e.section.requestURL.indexOf("?")>-1?"&":"?"}${this.#t>0?`variant=${this.#t}`:""}`);const a=`${this.#e.section.requestURL}${this.#e.section.requestURL.indexOf("?")>-1?"&":"?"}${this.#t>0?`variant=${this.#t}&`:""}section_id=${this.#e.section.sectionId}`;this.#h=new AbortController,this.#n.forEach((t=>{t.disabled=!0})),this.#v(!0);try{const e=await fetch(a,{signal:this.#h.signal});if(!e.ok)throw new Error(`[${t}] [Response error from the "${e.url}" URL]`);const i=await e.text();this.#y(i),this.#v(!1)}catch(t){if("AbortError"!==t.name)throw this.#y(this.#l),this.#v(!1),this.#g(!0),t}}#v(t){((t,e,i)=>{t.querySelectorAll(`[${e}]`).forEach((t=>{const a=t.getAttribute(e);a&&(i?t.classList.add(a):t.classList.remove(a))}))})(this,e.loadingClass,t)}#g(t){this.querySelectorAll(`[${e.errorMessage}]`).forEach((e=>{e.hidden=!t}))}#y(i){const a=(new DOMParser).parseFromString(i,"text/html").querySelector(`${t}${this.id?"#"+this.id:""}`);if(!a)throw new Error(`[${t}] [The "${t}" element is not found]`);this.#l=i,this.querySelector(`[${e.json}]`).innerHTML=a.querySelector(`[${e.json}]`).innerHTML;const s=Array.from(this.querySelectorAll(`[${e.area}]`)),r=Array.from(a.querySelectorAll(`[${e.area}]`));let n=!1;s.length!==r.length?(console.warn(`[${t}] [Previous "${e.area}" elements don't match the new received ones. The HTML of the component will be replaced completely.]`),this.innerHTML=a.innerHTML,a.querySelector("[data-shopify='payment-button']")&&(n=!0)):s.forEach(((t,i)=>{const a=r[i];let s="innerHTML";a.getAttribute(e.area)&&(s=a.getAttribute(e.area)),s.split(",").forEach((e=>{if("innerHTML"===(e=e.trim()))return t.innerHTML=a.innerHTML,void(a.querySelector("[data-shopify='payment-button']")&&(n=!0));a.hasAttribute(e)?t.setAttribute(e,a.getAttribute(e)):t.removeAttribute(e)}))})),n&&window.Shopify?.PaymentButton?.init(),this.#c()}#p(){const t={};this.#e.product.variants.forEach((e=>{for(let i=0;i<this.#a.length;i++){const a=this.#a[i],s=this.#e.product.options[a],r=e.options[a];s in t||(t[s]={});const n=t[s];if(n[r]||(n[r]=e.available),e.options[a]!==this.#i[a].value)break}}));const e=this.#s;this.#s=t;const i=Object.keys(t);if(i.length!==Object.keys(e).length)return!0;for(let a=0;a<i.length;a++){const s=i[a];if(!(s in e))return!0;const r=Object.keys(t[s]);if(r.length!==Object.keys(e[s]).length)return!0;for(let i=0;i<r.length;i++){const a=r[i];if(t[s][a]!==e[s][a])return!0}}return!1}get state(){return{variantId:this.#t,optionsValues:this.#i,optionsAvailability:this.#s}}}customElements.define(t,a)})();