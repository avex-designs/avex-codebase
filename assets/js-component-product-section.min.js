(()=>{const t="data-product-section-json",e="data-product-section-area",i="statechange",n="product-section";class a extends HTMLElement{#variantId;#data;#optionsValues=[];#optionsHierarchy=[];#optionsAvailability={};#$$variantInputs;#$$addToCartButtons;#isHydration=!1;#renderPromise=void 0;constructor(){super()}connectedCallback(){this.addEventListener(i,this.#render.bind(this)),this.#hydrate()}#hydrate(){this.#isHydration=!0;try{const e=this.querySelector(`[${t}]`);if(!e)throw new Error(`The mandatory ${t} element is not found`);if(this.#data=JSON.parse(e.innerHTML),this.#optionsHierarchy=this.#data.product.options.map(((t,e)=>e)),!("requestURL"in this.#data.section)||!("sectionId"in this.#data.section))throw new Error(`Wrong ${t} data structure`);this.#$$variantInputs=this.querySelectorAll("input[name='id']"),this.#$$addToCartButtons=this.querySelectorAll("[name='add']"),this.setVariantId(this.#data.section.variantId||0)}catch(t){throw this.#isHydration=!1,t}this.#isHydration=!1}setVariantId(t){let e;if(t>0){const i=this.#data.product.variants.find((e=>e.id===t));if(!i)throw new Error(`The variant "${t}" is not found in the product data object`);return e=this.#data.product.options.map(((t,e)=>({name:t,value:i.options[e]}))),this.#changeState({variantId:t,optionsValues:e})}return this.#changeState({variantId:0,optionsValues:this.#data.product.options.map((t=>({name:t,value:null})))})}setOptions(t){let e=!0;const i=this.#optionsValues.map((({name:i,value:n})=>{let a=i in t?t[i]:n;return null!=a&&""!==a||(a=null,e=!1),{name:i,value:a}}));if(!e)return this.#changeState({variantId:0,optionsValues:i});const n=this.#data.product.variants.find((t=>{for(let e=0;e<i.length;e++)if(i[e].value!==t.options[e])return!1;return!0})),a=n?n.id:null;return this.#changeState({variantId:a,optionsValues:i})}#changeState({variantId:t,optionsValues:e}){const n=t!==this.#variantId,a=e.reduce(((t,e,i)=>t||e.name!==this.#optionsValues[i]?.name||e.value!==this.#optionsValues[i]?.value),!1);this.#variantId=t,this.#optionsValues=e;const r=!(!a&&!this.#isHydration)&&this.#updateAvailability();(n||a||r)&&this.dispatchEvent(new CustomEvent(i,{detail:{isVariantChanged:n}}))}async#render(t){if(this.#renderPromise=void 0,this.#$$variantInputs.forEach((t=>{t.value=this.#variantId||"",t.setAttribute("value",this.#variantId||"")})),!t.detail.isVariantChanged||this.#isHydration)return;if(null===this.#variantId)return;this.#data.section.updateURL&&window.history.replaceState({},"",`${this.#data.section.requestURL}${this.#variantId>0?`?variant=${this.#variantId}`:""}`);const e=`${this.#data.section.requestURL}?${this.#variantId>0?`variant=${this.#variantId}&`:""}section_id=${this.#data.section.sectionId}`,i=this.#renderPromise=fetch(e);try{const t=await i;if(i!==this.#renderPromise)return;if(!t.ok)throw new Error(`Response error from the "${t.url}" URL`);const e=await t.text();this.#changeHTML(e),this.#hydrate()}catch(t){throw i===this.#renderPromise&&this.#hydrate(),t}}#changeHTML(i){const a=(new DOMParser).parseFromString(i,"text/html").querySelector(n);if(!a)throw new Error(`The "${n}" element is not found`);this.querySelector(`[${t}]`).innerHTML=a.querySelector(`[${t}]`).innerHTML;const r=Array.from(this.querySelectorAll(`[${e}]`)),s=Array.from(a.querySelectorAll(`[${e}]`));if(r.length!==s.length)return console.warn(`Previous "${e}" elements don't match the new received ones. The HTML of the component will be replaced completely.`),this.innerHTML=a.innerHTML,void(a.querySelector("[data-shopify='payment-button']")&&window.Shopify?.PaymentButton?.init());let o=!1;r.forEach(((t,i)=>{const n=s[i];let a="innerHTML";n.getAttribute(e)&&(a=n.getAttribute(e)),a.split(",").forEach((e=>{if("innerHTML"===(e=e.trim()))return t.innerHTML=n.innerHTML,void(n.querySelector("[data-shopify='payment-button']")&&(o=!0));n.hasAttribute(e)?t.setAttribute(e,n.getAttribute(e)):t.removeAttribute(e)}))})),o&&window.Shopify?.PaymentButton?.init()}#updateAvailability(){const t={};this.#data.product.variants.forEach((e=>{for(let i=0;i<this.#optionsHierarchy.length;i++){const n=this.#optionsHierarchy[i],a=this.#data.product.options[n],r=e.options[n];a in t||(t[a]={});const s=t[a];if(s[r]||(s[r]=e.available),e.options[n]!==this.#optionsValues[n].value)break}}));const e=this.#optionsAvailability;this.#optionsAvailability=t;const i=Object.keys(t);if(i.length!==Object.keys(e).length)return!0;for(let n=0;n<i.length;n++){const a=i[n];if(!(a in e))return!0;const r=Object.keys(t[a]);if(r.length!==Object.keys(e[a]).length)return!0;for(let i=0;i<r.length;i++){const n=r[i];if(t[a][n]!==e[a][n])return!0}}return!1}get state(){return{variantId:this.#variantId,optionsValues:this.#optionsValues,optionsAvailability:this.#optionsAvailability}}}customElements.define(n,a)})();