(()=>{"use strict";class t extends HTMLElement{#t;#e="[[value]]";#a={undefined:"undefined",available:"available",not_available:"not-available",does_not_exist:"does-not-exist"};#i="js-product-option-";dataAttributes={};optionName;$productSection;constructor(t){super(),this.#t=t,this.dataAttributes={name:`data-${t}-name`,valueLabel:`data-${t}-value`,classPrefix:`data-${t}-class-prefix`}}connectedCallbackStart(){if(this.optionName=this.getAttribute(this.dataAttributes.name),void 0===this.optionName||""===this.optionName)throw new Error(`[${this.#t}] [Product option name is not set]`);if(this.$productSection=this.closest("product-section"),!this.$productSection)throw new Error(`[${this.#t}] [A related product-section element is not found]`);this.#i=this.getAttribute(this.dataAttributes.classPrefix)||this.#i}connectedCallbackEnd(){this.$productSection.addEventListener("statechange",(()=>{this.render()})),this.$productSection.state&&this.render()}getOptionState(){return this.$productSection.state.optionsValues.find((t=>t.name===this.optionName))}#s(t){const e=this.$productSection.state.optionsAvailability[this.optionName];let a=this.#a.undefined;return e&&(t in e?e[t]?this.#a.available:this.#a.not_available:this.#a.does_not_exist),a}addAvailabilityClass(t,e){t.classList.remove(...Object.values(this.#a).map((t=>this.#i+t))),t.classList.add(this.#i+this.#s(e))}render(){const t=this.getOptionState();if(t){const e=t.value;this.querySelectorAll(`[${this.dataAttributes.valueLabel}]`).forEach((t=>{if(!e)return void(t.innerHTML="");const a=t.getAttribute(this.dataAttributes.valueLabel)||this.#e;t.innerHTML=a.replaceAll(this.#e,e)}))}}}const e="product-section",a={json:`data-${e}-json`,area:`data-${e}-area`,doesNotExistText:`data-${e}-doesnotexist`,loadingClass:`data-${e}-loading-class`,errorMessage:`data-${e}-error`},i="statechange";class s extends HTMLElement{#n;#o;#r=[];#l=[];#h={};#d;#c;#u=!1;#p;#v;constructor(){super()}connectedCallback(){this.addEventListener(i,this.#b.bind(this)),this.#v=`<div>${this.outerHTML}</div>`,this.#f()}#f(){this.#u=!0;try{const t=this.querySelector(`[${a.json}]`);if(!t)throw new Error(`[${e}] [The mandatory ${a.json} element is not found]`);if(this.#o=JSON.parse(t.innerHTML),this.#l=this.#o.product.options.map(((t,e)=>e)),!("requestURL"in this.#o.section)||!("sectionId"in this.#o.section))throw new Error(`[${e}] [Wrong ${a.json} data structure]`);this.#d=this.querySelectorAll("input[name='id']"),this.#c=this.querySelectorAll("[name='add']"),this.setVariantId(this.#o.section.variantId||0)}catch(t){throw this.#u=!1,t}this.#u=!1}setVariantId(t){let a;if(t>0){const i=this.#o.product.variants.find((e=>e.id===t));if(!i)throw new Error(`[${e}] [The variant "${t}" is not found in the product data object]`);return a=this.#o.product.options.map(((t,e)=>({name:t,value:i.options[e]}))),this.#g({variantId:t,optionsValues:a})}return this.#g({variantId:0,optionsValues:this.#o.product.options.map((t=>({name:t,value:null})))})}setOptions(t){let e=!0;const a=this.#r.map((({name:a,value:i})=>{let s=a in t?t[a]:i;return null!=s&&""!==s||(s=null,e=!1),{name:a,value:s}}));if(!e)return this.#g({variantId:0,optionsValues:a});const i=this.#o.product.variants.find((t=>{for(let e=0;e<a.length;e++)if(a[e].value!==t.options[e])return!1;return!0})),s=i?i.id:null;return this.#g({variantId:s,optionsValues:a})}#g({variantId:t,optionsValues:e}){const a=t!==this.#n,s=e.reduce(((t,e,a)=>t||e.name!==this.#r[a]?.name||e.value!==this.#r[a]?.value),!1);this.#n=t,this.#r=e;const n=!(!s&&!this.#u)&&this.#y();(a||s||n)&&this.dispatchEvent(new CustomEvent(i,{detail:{isVariantChanged:a}}))}async#b(t){if(this.#p&&(this.#p.abort(),this.#p=void 0),this.#d.forEach((t=>{t.value=this.#n||"",t.setAttribute("value",this.#n||"")})),this.#m(!1),this.#$(!1),!t.detail.isVariantChanged||this.#u)return;if(null===this.#n)return this.#c.forEach((t=>{t.disabled=!0})),void this.querySelectorAll(`[${a.doesNotExistText}]`).forEach((t=>{const e=t.getAttribute(a.doesNotExistText);e&&(t.textContent=e)}));this.#o.section.updateURL&&window.history.replaceState({},"",`${this.#o.section.requestURL}${this.#o.section.requestURL.indexOf("?")>-1?"&":"?"}${this.#n>0?`variant=${this.#n}`:""}`);const i=`${this.#o.section.requestURL}${this.#o.section.requestURL.indexOf("?")>-1?"&":"?"}${this.#n>0?`variant=${this.#n}&`:""}section_id=${this.#o.section.sectionId}`;this.#p=new AbortController,this.#c.forEach((t=>{t.disabled=!0})),this.#m(!0);try{const t=await fetch(i,{signal:this.#p.signal});if(!t.ok)throw new Error(`[${e}] [Response error from the "${t.url}" URL]`);const a=await t.text();this.#L(a),this.#m(!1)}catch(t){if("AbortError"!==t.name)throw this.#L(this.#v),this.#m(!1),this.#$(!0),t}}#m(t){((t,e,a)=>{t.querySelectorAll(`[${e}]`).forEach((t=>{const i=t.getAttribute(e);i&&(a?t.classList.add(i):t.classList.remove(i))}))})(this,a.loadingClass,t)}#$(t){this.querySelectorAll(`[${a.errorMessage}]`).forEach((e=>{e.hidden=!t}))}#L(t){const i=(new DOMParser).parseFromString(t,"text/html").querySelector(`${e}${this.id?"#"+this.id:""}`);if(!i)throw new Error(`[${e}] [The "${e}" element is not found]`);this.#v=t,this.querySelector(`[${a.json}]`).innerHTML=i.querySelector(`[${a.json}]`).innerHTML;const s=Array.from(this.querySelectorAll(`[${a.area}]`)),n=Array.from(i.querySelectorAll(`[${a.area}]`));let o=!1;s.length!==n.length?(console.warn(`[${e}] [Previous "${a.area}" elements don't match the new received ones. The HTML of the component will be replaced completely.]`),this.innerHTML=i.innerHTML,i.querySelector("[data-shopify='payment-button']")&&(o=!0)):s.forEach(((t,e)=>{const i=n[e];let s="innerHTML";i.getAttribute(a.area)&&(s=i.getAttribute(a.area)),s.split(",").forEach((e=>{if("innerHTML"===(e=e.trim()))return t.innerHTML=i.innerHTML,void(i.querySelector("[data-shopify='payment-button']")&&(o=!0));i.hasAttribute(e)?t.setAttribute(e,i.getAttribute(e)):t.removeAttribute(e)}))})),o&&window.Shopify?.PaymentButton?.init(),this.#f()}#y(){const t={};this.#o.product.variants.forEach((e=>{for(let a=0;a<this.#l.length;a++){const i=this.#l[a],s=this.#o.product.options[i],n=e.options[i];s in t||(t[s]={});const o=t[s];if(o[n]||(o[n]=e.available),e.options[i]!==this.#r[i].value)break}}));const e=this.#h;this.#h=t;const a=Object.keys(t);if(a.length!==Object.keys(e).length)return!0;for(let i=0;i<a.length;i++){const s=a[i];if(!(s in e))return!0;const n=Object.keys(t[s]);if(n.length!==Object.keys(e[s]).length)return!0;for(let a=0;a<n.length;a++){const i=n[a];if(t[s][i]!==e[s][i])return!0}}return!1}get state(){return{variantId:this.#n,optionsValues:this.#r,optionsAvailability:this.#h}}}customElements.define(e,s)})();