(()=>{class t extends HTMLElement{constructor(){super(),this.globalEvents()}connectedCallback(){const t=this.querySelector("[data-klaviyo-backinstock-close]"),e=this.querySelector("form");if(!e)return console.error("[KlaviyoBIS]: form tag not detected");t&&t.addEventListener("click",this.toggleModalVisibilty.bind(this)),document.addEventListener("keyup",(t=>{"ESCAPE"===t.code?.toUpperCase()&&this.toggleModalVisibilty()})),this.addEventListener("click",(t=>{"KLAVIYO-BACKINSTOCK"===t.target.nodeName&&this.toggleModalVisibilty()})),e.addEventListener("submit",(t=>{t.preventDefault();const e=new FormData(t.currentTarget);this.setAttribute("loading",""),fetch("https://a.klaviyo.com/onsite/components/back-in-stock/subscribe",{method:"post",body:e}).then((t=>t.json())).then((t=>{t.success?this.setAttribute("success",""):(this.removeAttribute("error"),console.error("[KlaviyoBIS]: ",t)),this.removeAttribute("loading")})).catch((t=>(this.removeAttribute("loading"),console.error("[KlaviyoBIS]: fetching error - ",t))))}))}toggleModalVisibilty(){document.body.toggleAttribute("data-klaviyo-bis-modal-open"),this.toggleAttribute("open")}globalEvents(){console.log("Init"),this.init(),this.notifyButtonClickEvent()}init(){const t=document.querySelectorAll("form[action='/cart/add']");if(!t||!t.length)return console.error("[KlaviyoBIS]: No forms detected");for(let e=0;e<t.length;e++){const o=t[e],i=this.getProductData(o);if(i&&i.parsedProductVariants&&i.selectedVariantID){const t=i.parsedProductVariants.find((t=>t.id===Number(i.selectedVariantID)));t&&!t.available&&o.setAttribute("data-klaviyo-backinstock-notify","")}}}notifyButtonClickEvent(){const t=this.querySelector("[data-klaviyo-backinstock-body]");document.addEventListener("click",(e=>{if(e){this.removeAttribute("success");const o=e.target.closest("[data-klaviyo-backinstock-notify-button]");if(o){const e=o.closest("form[action='/cart/add']");if(e){const o=this.getProductData(e);o&&(t.appendChild(this.variantsSelectorInput(o.selectedVariantID,o.parsedProductVariants)),this.toggleModalVisibilty())}}}}),!1)}getProductData(t){const e=t.querySelector("[name='id']")?.value,o=t.querySelector("[data-product-json-variants]"),i=o&&""!==o.textContent&&JSON.parse(o.textContent);return i&&e?{selectedVariantID:e,parsedProductVariants:i}:(console.error("[KlaviyoBIS]: Product variants JSON object not added or there is no default variant selected"),null)}variantsSelectorInput(t,e){if(!e)return null;const o=document.createElement(e.length>1?"select":"input");if(o.name="variant",1===e.length)o.type="hidden",o.value=e[0]?.id;else{let t="";for(let o=0;o<e.length;o++)t+=`<option value="${e[o].id}" ${e[o].available&&"disabled"}>${e[o].title}</option>`;o.innerHTML=t}return t&&(o.value=t),o}}customElements.define("klaviyo-backinstock",t)})();