(()=>{const t="klaviyo-bis",e={body:`data-${t}-body`,close:`data-${t}-close`,open:`data-${t}-open`,requestUrl:`data-${t}-url`,responseMessage:`data-${t}-response`};class s extends HTMLElement{constructor(){if(super(),this.$closeElements=this.querySelectorAll(`[${e.close}]`),this.$formElement=this.querySelector("form"),!this.$formElement)throw new Error("[KlaviyoBIS] Form not found")}connectedCallback(){this.#t(),this.#e(),document.addEventListener("click",(t=>{this.#s(t)}),!1)}async#s(s){const r=s.target.closest(`[${e.open}]`);if(!r)return;s.preventDefault(),this.#r(!0),this.#o(!0);const o=r.closest("form"),i=r.getAttribute(e.requestUrl),n=o?.querySelector("[name='id']")?.value||0,a=`${i}${i.indexOf("?")>-1?"&":"?"}${parseInt(n)>0?`variant=${n}&`:""}section_id=${t}`;try{const t=await fetch(a);if(!t.ok)throw new Error("[KlaviyoBIS] Response error");const e=await t.text();this.#i(e),this.#o(!1)}catch(t){throw new Error(`[KlaviyoBIS] ${t}`)}}#i(s){const r=(new DOMParser).parseFromString(s,"text/html").querySelector(`${t}${this.id?"#"+this.id:""}`);if(!r)throw new Error("[KlaviyoBIS] Element not found");this.querySelector(`[${e.body}]`).innerHTML=r.querySelector(`[${e.body}]`).innerHTML}async#e(){this.$formElement.addEventListener("submit",(async t=>{t.preventDefault(),this.#n(),this.#o(!0);try{const t={data:{type:"back-in-stock-subscription",attributes:{profile:{data:{type:"profile",attributes:{email:e.get("email")}}},channels:["EMAIL"]},relationships:{variant:{data:{type:"catalog-variant",id:`$shopify:::$default:::${e.get("variant")}`}}}}},e=new FormData(this.$formElement),s=await fetch(this.$formElement.action,{method:"post",headers:{"Content-Type":"application/json",accept:"application/json",revision:"2023-09-15"},body:JSON.stringify(t)});202===s?.status?this._success(!0):this._error(!0),this.#o(!1)}catch(t){throw this.#o(!1),new Error(`[KlaviyoBIS] ${t}`)}}))}#t(){const t=this;if(document.addEventListener("keyup",(e=>{"ESCAPE"===e.code?.toUpperCase()&&t.#r(!1)})),!this.$closeElements||!this.$closeElements.length)return console.warn("[KlaviyoBIS] Close element not found");this.$closeElements.forEach((e=>e.addEventListener("click",(e=>{e.preventDefault(),t.#r(!1)}))))}#r(t){this.#n(),t?this.setAttribute("open",""):this.removeAttribute("open")}#o(t){t?this.setAttribute("loading",""):this.removeAttribute("loading")}#a(t){t?this.setAttribute("success",""):this.removeAttribute("success")}#l(t){t?this.setAttribute("error",""):this.removeAttribute("error")}#n(){this.#l(!1),this.#a(!1),this.#o(!1)}}customElements.define(t,s)})();