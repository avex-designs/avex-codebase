(()=>{const e="klaviyo-bis",t={body:`data-${e}-body`,close:`data-${e}-close`,open:`data-${e}-open`,requestUrl:`data-${e}-url`,responseMessage:`data-${e}-response`};class s extends HTMLElement{constructor(){if(super(),this.$closeElements=this.querySelectorAll(`[${t.close}]`),this.$formElement=this.querySelector("form"),!this.$formElement)throw new Error("[KlaviyoBIS] Form not found")}connectedCallback(){this.#e(),this.#t(),document.addEventListener("click",(e=>{this.#s(e)}),!1)}async#s(s){const r=s.target.closest(`[${t.open}]`);if(!r)return;s.preventDefault(),this.#r(!0),this.#o(!0);const o=r.closest("form"),n=r.getAttribute(t.requestUrl),i=o?.querySelector("[name='id']")?.value||0,l=`${n}${n.indexOf("?")>-1?"&":"?"}${parseInt(i)>0?`variant=${i}&`:""}section_id=${e}`;try{const e=await fetch(l);if(!e.ok)throw new Error("[KlaviyoBIS] Response error");const t=await e.text();this.#n(t),this.#o(!1)}catch(e){throw new Error(`[KlaviyoBIS] ${e}`)}}#n(s){const r=(new DOMParser).parseFromString(s,"text/html").querySelector(`${e}${this.id?"#"+this.id:""}`);if(!r)throw new Error("[KlaviyoBIS] Element not found");this.querySelector(`[${t.body}]`).innerHTML=r.querySelector(`[${t.body}]`).innerHTML}async#t(){this.$formElement.addEventListener("submit",(async e=>{e.preventDefault(),this.#i(),this.#o(!0);try{const e=new FormData(this.$formElement),t=await fetch(this.$formElement.action,{method:"post",body:e}).then((e=>e.json()));t?.success?this.#l(!0):this.#a(!0),this.#o(!1)}catch(e){throw this.#o(!1),new Error(`[KlaviyoBIS] ${e}`)}}))}#e(){const e=this;if(document.addEventListener("keyup",(t=>{"ESCAPE"===t.code?.toUpperCase()&&e.#r(!1)})),!this.$closeElements||!this.$closeElements.length)return console.warn("[KlaviyoBIS] Close element not found");this.$closeElements.forEach((t=>t.addEventListener("click",(t=>{t.preventDefault(),e.#r(!1)}))))}#r(e){this.#i(),e?this.setAttribute("open",""):this.removeAttribute("open")}#o(e){e?this.setAttribute("loading",""):this.removeAttribute("loading")}#l(e){e?this.setAttribute("success",""):this.removeAttribute("success")}#a(e){e?this.setAttribute("error",""):this.removeAttribute("error")}#i(){this.#a(!1),this.#l(!1),this.#o(!1)}}customElements.define(e,s)})();