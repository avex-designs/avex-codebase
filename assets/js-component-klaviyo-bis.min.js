(()=>{const t="klaviyo-bis",e={body:`data-${t}-body`,close:`data-${t}-close`,open:`data-${t}-open`,requestUrl:`data-${t}-url`,responseMessage:`data-${t}-response`};class s extends HTMLElement{constructor(){if(super(),this.$closeElements=this.querySelectorAll(`[${e.close}]`),this.$formElement=this.querySelector("form"),!this.$formElement)throw new Error("[KlaviyoBIS] Form not found")}connectedCallback(){this._setCloseEvent(),this._submitForm(),document.addEventListener("click",(t=>{this._setOpenEvent(t)}),!1)}async _setOpenEvent(s){const o=s.target.closest(`[${e.open}]`);if(!o)return;s.preventDefault(),this._toggle(!0),this._loading(!0);const r=o.closest("form"),i=o.getAttribute(e.requestUrl),n=r?.querySelector("[name='id']")?.value||0,a=`${i}${i.indexOf("?")>-1?"&":"?"}${parseInt(n)>0?`variant=${n}&`:""}section_id=${t}`;try{const t=await fetch(a);if(!t.ok)throw new Error("[KlaviyoBIS] Response error");const e=await t.text();this._replaceHTML(e),this._loading(!1)}catch(t){throw new Error(`[KlaviyoBIS] ${t}`)}}_replaceHTML(s){const o=(new DOMParser).parseFromString(s,"text/html").querySelector(`${t}${this.id?"_"+this.id:""}`);if(!o)throw new Error("[KlaviyoBIS] Element not found");this.querySelector(`[${e.body}]`).innerHTML=o.querySelector(`[${e.body}]`).innerHTML}async _submitForm(){this.$formElement.addEventListener("submit",(async t=>{t.preventDefault();const e=new FormData(this.$formElement);this._reset(),this._loading(!0);try{const t={data:{type:"back-in-stock-subscription",attributes:{profile:{data:{type:"profile",attributes:{email:e.get("email")}}},channels:["EMAIL"]},relationships:{variant:{data:{type:"catalog-variant",id:`$shopify:::$default:::${e.get("variant")}`}}}}},s=await fetch(this.$formElement.action,{method:"post",headers:{"Content-Type":"application/json",accept:"application/json",revision:"2023-09-15"},body:JSON.stringify(t)});202===s?.status?this._success(!0):this._error(!0),this._loading(!1)}catch(t){throw this._loading(!1),new Error(`[KlaviyoBIS] ${t}`)}}))}_setCloseEvent(){const t=this;if(document.addEventListener("keyup",(e=>{"ESCAPE"===e.code?.toUpperCase()&&t._toggle(!1)})),!this.$closeElements||!this.$closeElements.length)return console.warn("[KlaviyoBIS] Close element not found");this.$closeElements.forEach((e=>e.addEventListener("click",(e=>{e.preventDefault(),t._toggle(!1)}))))}_toggle(t){this._reset(),t?this.setAttribute("open",""):this.removeAttribute("open")}_loading(t){t?this.setAttribute("loading",""):this.removeAttribute("loading")}_success(t){t?this.setAttribute("success",""):this.removeAttribute("success")}_error(t){t?this.setAttribute("error",""):this.removeAttribute("error")}_reset(){this._error(!1),this._success(!1),this._loading(!1)}}customElements.define(t,s)})();